<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Eclipse Hub — Year Progress, Countdown, NASA APOD, Visibility</title>
<style>
	:root{
		--bg:#0d1117; --fg:#eee; --accent:#ffcc00; --muted:#9aa0a6;
		--card:#0f1720; --glass: rgba(255,255,255,0.03);
	}
	[data-theme="light"]{
		--bg:#f6f7f9; --fg:#111; --accent:#0057b8; --muted:#555; --card:#ffffff; --glass: rgba(0,0,0,0.03);
	}
	html,body{height:100%; margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--fg);}
	.app{min-height:100%; display:flex; flex-direction:column; align-items:center; padding:24px; box-sizing:border-box;}
	header{width:100%; max-width:1100px; display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:14px;}
	h1{font-size:20px; margin:0; font-weight:600;}
	.controls{display:flex; gap:10px; align-items:center;}
	button{background:var(--accent); color:var(--bg); border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
	button.secondary{background:transparent; color:var(--fg); border:1px solid rgba(255,255,255,0.06);}
	.row{width:100%; max-width:1100px; display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start;}
	.card{background:var(--card); border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,0.25); overflow:hidden;}
	.progress-wrap{width:100%; display:flex; flex-direction:column; gap:10px;}
	.bar{height:18px; background:rgba(255,255,255,0.06); border-radius:999px; overflow:hidden;}
	.fill{height:100%; background:linear-gradient(90deg,#ff4d4d,var(--accent)); width:0%; transition:width 600ms linear;}
	.eclipse-list{display:flex; flex-direction:column; gap:8px; max-height:220px; overflow:auto;}
	.eclipse-item{display:flex; justify-content:space-between; align-items:center; padding:8px; background:var(--glass); border-radius:8px;}
	.countdown{font-size:16px; margin-top:6px; font-weight:600;}
	#apodImg{width:100%; border-radius:10px; display:block; max-height:260px; object-fit:cover; background:#000;}
	.caption{font-size:13px; color:var(--muted); margin-top:8px; line-height:1.3;}
	.small{font-size:13px; color:var(--muted);}
	.visibility{margin-top:10px; padding:10px; border-radius:8px; font-weight:700;}
	.visible{background:rgba(0,128,0,0.08); color:#00b36b;}
	.partial{background:rgba(255,165,0,0.06); color:#ff9f1c;}
	.not{background:rgba(200,30,30,0.04); color:#ff6b6b;}

	/* star canvas full-screen subtle */
	.star-canvas{position:fixed; left:0; top:0; width:100%; height:100%; z-index:-1; pointer-events:none; opacity:0.45;}

	.footer{width:100%; max-width:1100px; margin-top:18px; padding:12px; border-radius:10px; background:var(--card); color:var(--muted);}
	.features{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:8px;}
	.tag{background:var(--glass); padding:8px; border-radius:8px; font-size:13px; color:var(--muted);}

	@media(max-width:880px){ .row{grid-template-columns:1fr; } .controls{flex-wrap:wrap;} }
</style>
</head>
<body data-theme="dark">
<canvas id="stars" class="star-canvas" aria-hidden="true"></canvas>

<div class="app">
	<header>
		<h1>Eclipse Hub</h1>
		<div class="controls">
			<button id="themeBtn">Toggle Theme</button>
			<button id="locBtn" class="secondary">Detect Location</button>
			<button id="refreshApod">Refresh NASA Image</button>
		</div>
	</header>

	<div class="row">
		<!-- left: main -->
		<section class="card">
			<div style="display:flex;justify-content:space-between;align-items:center;">
				<div>
					<div class="small">Year progress (0–100% by seconds)</div>
					<div class="progress-wrap" style="margin-top:8px;">
						<div class="bar"><div class="fill" id="fill"></div></div>
					</div>
				</div>
				<div style="text-align:right;">
					<div class="small">Today</div>
					<div id="today" style="font-weight:700;"></div>
				</div>
			</div>

			<hr style="margin:14px 0; border:none; height:1px; background:rgba(255,255,255,0.03);" />

			<div style="display:flex; gap:12px; align-items:flex-start;">
				<!-- next eclipse + countdown -->
				<div style="flex:1;">
					<div class="small">Upcoming eclipses</div>
					<div class="eclipse-list" id="eclipseList" style="margin-top:10px;"></div>

					<div class="countdown" style="margin-top:12px;">Countdown to nearest eclipse: <span id="timer">—</span></div>
					<div id="visibility" class="visibility small not" style="display:none;"></div>
				</div>

				<!-- APOD -->
				<div style="width:320px;">
					<img id="apodImg" alt="NASA APOD image" />
					<div id="apodTitle" class="caption"></div>
					<div id="apodCredit" class="small" style="margin-top:6px;"></div>
				</div>
			</div>
		</section>

		<!-- right: calendar / info -->
		<aside class="card">
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
				<div style="font-weight:700;">Eclipse Calendar</div>
				<div class="small">Static / Local</div>
			</div>

			<div id="calendar" style="display:flex; flex-direction:column; gap:8px; max-height:520px; overflow:auto;"></div>

			<hr style="margin:12px 0; border:none; height:1px; background:rgba(255,255,255,0.03);" />
			<div style="font-size:13px; color:var(--muted);">
				Visibility approximations use simplified regions derived from NASA / TimeandDate data. For precise local visibility, consult official maps.  [oai_citation:1‡eclipse.gsfc.nasa.gov](https://eclipse.gsfc.nasa.gov/SEgoogle/SEgoogle2001/SE2026Aug12Tgoogle.html?utm_source=chatgpt.com)
			</div>
		</aside>
	</div>

	<!-- footer features list -->
	<footer class="footer">
		<div style="font-weight:700; margin-bottom:8px;">Features added</div>
		<div class="features" id="featureTags"></div>
	</footer>
</div>

<script>
/* -------------------------
   Data: eclipses (calendar)
   For each eclipse we include:
   - id, type, title, dateISO (UTC), approxVisibilityRegions (polygons/bboxes)
   The visibility regions are intentionally approximate for client-side checks (Option A).
   ------------------------- */
const eclipses = [
	{
		id: "lunar-2026-03-03",
		type: "Lunar",
		title: "Total Lunar Eclipse — Mar 3, 2026",
		dateISO: "2026-03-03T17:50:00Z",
		// broad region masks (latMin, latMax, lonMin, lonMax) approximate
		visibilityRegions: [
			// Northeast Asia / Australia / Pacific (approx)
			{latMin: -50, latMax: 70, lonMin: 60, lonMax: 180},
			// North/Central America (rising/setting visible edges)
			{latMin: 10, latMax: 75, lonMin: -170, lonMax: -50}
		]
	},
	{
		id: "solar-2026-08-12",
		type: "Solar",
		title: "Total Solar Eclipse — Aug 12, 2026",
		dateISO: "2026-08-12T10:00:00Z",
		// solar path crosses Arctic, Greenland, Iceland, Portugal, Spain (approx)
		visibilityRegions: [
			{latMin:50, latMax:90, lonMin:-170, lonMax:40}, // Arctic / Greenland / Russia band
			{latMin:35, latMax:45, lonMin:-20, lonMax:10},  // Portugal / Spain approx box
		]
	},
	{
		id: "lunar-2026-08-28",
		type: "Lunar",
		title: "Partial Lunar Eclipse — Aug 28, 2026",
		dateISO: "2026-08-28T20:00:00Z",
		visibilityRegions: [
			{latMin:-60, latMax:80, lonMin:-160, lonMax:160}
		]
	},
	// Add more if you want...
];

/* ---------- UI helpers ---------- */
const fillEl = document.getElementById("fill");
const todayEl = document.getElementById("today");
const eclipseListEl = document.getElementById("eclipseList");
const calendarEl = document.getElementById("calendar");
const timerEl = document.getElementById("timer");
const visibilityEl = document.getElementById("visibility");
const apodImg = document.getElementById("apodImg");
const apodTitle = document.getElementById("apodTitle");
const apodCredit = document.getElementById("apodCredit");
const featureTags = document.getElementById("featureTags");

/* ---------- show static calendar and list ---------- */
function renderCalendar(){
	calendarEl.innerHTML = "";
	eclipseListEl.innerHTML = "";
	eclipses.sort((a,b)=> new Date(a.dateISO)-new Date(b.dateISO)).forEach(e=>{
		const d = new Date(e.dateISO);
		const card = document.createElement("div");
		card.className = "tag";
		card.innerHTML = `<div style="font-weight:700">${e.title}</div><div class="small">${d.toUTCString()}</div>`;
		calendarEl.appendChild(card);

		// list item
		const li = document.createElement("div");
		li.className = "eclipse-item";
		li.innerHTML = `<div style="font-weight:600">${e.title}</div><div class="small">${d.toLocaleString()}</div>`;
		eclipseListEl.appendChild(li);
	});
}
renderCalendar();

/* ---------- Year progress by seconds ---------- */
function updateProgress(){
	const now = new Date();
	todayEl.textContent = now.toLocaleDateString();
	const start = new Date(now.getFullYear(),0,1);
	const end = new Date(now.getFullYear()+1,0,1);
	const pct = ((now - start) / (end - start)) * 100;
	fillEl.style.width = Math.min(100, Math.max(0, pct)).toFixed(3) + "%";
}
setInterval(updateProgress, 1000);
updateProgress();

/* ---------- Nearest eclipse + countdown ---------- */
function getNextEclipse(){
	const now = Date.now();
	const future = eclipses.map(e=>({...e, time: new Date(e.dateISO).getTime()}))
						.filter(e=>e.time > now)
						.sort((a,b)=>a.time-b.time);
	return future.length? future[0] : null;
}
function updateCountdown(){
	const next = getNextEclipse();
	if(!next){ timerEl.textContent = "No future eclipse in list"; return; }
	const diff = new Date(next.dateISO) - new Date();
	if(diff <= 0){ timerEl.textContent = "Happening now or passed"; return; }
	let s = Math.floor(diff/1000);
	const days = Math.floor(s / (86400)); s %= 86400;
	const hrs = Math.floor(s/3600); s %= 3600;
	const mins = Math.floor(s/60); const secs = s%60;
	timerEl.textContent = `${days}d ${hrs}h ${mins}m ${secs}s`;
}
setInterval(updateCountdown,1000);
updateCountdown();

/* ---------- Simple visibility check (Option A) ----------
   Check: obtain user lat/lon. For each eclipse, test if point in any bounding region.
   Result levels: Visible (inside primary region), Partial (nearby within expanded box), Not visible.
   This is approximate. For precise local maps consult NASA/TimeandDate. 
   Sources used to derive broad regions: NASA GSFC, TimeandDate.  [oai_citation:2‡eclipse.gsfc.nasa.gov](https://eclipse.gsfc.nasa.gov/SEgoogle/SEgoogle2001/SE2026Aug12Tgoogle.html?utm_source=chatgpt.com)
---------------------------------------------- */
function pointInBox(pt, box){
	return pt.lat >= box.latMin && pt.lat <= box.latMax && pt.lon >= box.lonMin && pt.lon <= box.lonMax;
}
function computeVisibilityForPoint(pt){
	const now = new Date();
	const near = 1000 * 60 * 60 * 24 * 365 * 2; // 2 years window (we only have near-term events)
	const upcoming = eclipses.filter(e=> Math.abs(new Date(e.dateISO) - now) < near );
	if(!upcoming.length) return {status:"NoData", text:"No upcoming eclipse data."};

	const next = getNextEclipse() || upcoming[0];
	let level="Not visible"; let which=null;

	for(const region of (next.visibilityRegions||[])){
		if(pointInBox(pt, region)){ level="Visible"; which = next; break; }
	}
	// if not in primary boxes, test expanded boxes for 'Partial'
	if(level === "Not visible"){
		for(const region of (next.visibilityRegions||[])){
			// expand box by 10 degrees to approximate partial visibility
			const expanded = {latMin: region.latMin-10, latMax: region.latMax+10, lonMin: region.lonMin-12, lonMax: region.lonMax+12};
			if(pointInBox(pt, expanded)){ level="Partially visible"; which = next; break; }
		}
	}
	return {status: level, eclipse: which, text: level + (which ? ` — ${which.title}` : "")};
}

/* ---------- Geolocation integration ---------- */
const locBtn = document.getElementById("locBtn");
locBtn.addEventListener("click", detectLocation);
function detectLocation(){
	visibilityEl.style.display="none";
	if(!navigator.geolocation){
		alert("Geolocation not supported by this browser.");
		return;
	}
	locBtn.textContent = "Detecting…";
	navigator.geolocation.getCurrentPosition(pos=>{
		locBtn.textContent = "Detect Location";
		const coords = {lat: pos.coords.latitude, lon: pos.coords.longitude};
		const res = computeVisibilityForPoint(coords);
		visibilityEl.style.display="block";
		visibilityEl.className = "visibility small " + (res.status==="Visible"?"visible":(res.status==="Partially visible"?"partial":"not"));
		visibilityEl.textContent = `Visibility: ${res.text} (approximate) — Coordinates: ${coords.lat.toFixed(3)}, ${coords.lon.toFixed(3)}`;
	}, err=>{
		locBtn.textContent = "Detect Location";
		alert("Location permission denied or error retrieving location.");
	});
}

/* ---------- Theme toggle ---------- */
const themeBtn = document.getElementById("themeBtn");
themeBtn.addEventListener("click", ()=>{
	const el = document.body;
	const current = el.getAttribute("data-theme") || "dark";
	const next = current === "dark" ? "light" : "dark";
	el.setAttribute("data-theme", next);
});

/* ---------- NASA APOD with offline caching (localStorage) ----------
   - Uses NASA APOD public endpoint. Replace API_KEY if you have one.
   - Caches the JSON result + image URL in localStorage for faster reload.
   - Cache TTL: 24 hours (configurable).
---------------------------------------------- */
const API_KEY = "DEMO_KEY"; // replace with your key if you have one
const APOD_CACHE_KEY = "apod_cache_v1";
const APOD_TTL = 1000 * 60 * 60 * 24; // 24 hours

async function loadAPOD(force=false){
	try{
		// check cache
		const cachedRaw = localStorage.getItem(APOD_CACHE_KEY);
		if(!force && cachedRaw){
			const cached = JSON.parse(cachedRaw);
			const age = Date.now() - cached.ts;
			if(age < APOD_TTL){
				applyAPOD(cached.data);
				return;
			}
		}
		// fetch fresh
		const resp = await fetch(`https://api.nasa.gov/planetary/apod?api_key=${API_KEY}`);
		if(!resp.ok) throw new Error("APOD fetch failed");
		const data = await resp.json();
		// If non-image, still cache the title / explanation
		localStorage.setItem(APOD_CACHE_KEY, JSON.stringify({ts:Date.now(), data}));
		applyAPOD(data);
	}catch(e){
		console.warn("APOD error", e);
		apodTitle.textContent = "Failed to load NASA APOD.";
	}
}
function applyAPOD(data){
	if(!data) return;
	if(data.media_type === "image"){
		apodImg.src = data.url;
		apodImg.style.display = "";
	} else {
		apodImg.style.display = "none";
	}
	apodTitle.textContent = data.title ? `${data.title} — ${data.date}` : "";
	apodCredit.textContent = data.copyright ? `© ${data.copyright}` : `Source: NASA APOD`;
}
document.getElementById("refreshApod").addEventListener("click", ()=> loadAPOD(true));
loadAPOD(false);

/* ---------- subtle animated starfield (canvas) ----------
   Simple performant particle-based starfield
---------------------------------------------- */
const canvas = document.getElementById("stars");
const ctx = canvas.getContext("2d");
let W, H, stars=[];
function resizeCanvas(){ W = canvas.width = innerWidth; H = canvas.height = innerHeight; initStars(); }
function initStars(){
	stars = [];
	const count = Math.min(300, Math.floor((W*H)/20000));
	for(let i=0;i<count;i++){
		stars.push({
			x: Math.random()*W,
			y: Math.random()*H,
			r: Math.random()*1.4 + 0.2,
			vx: (Math.random()-0.5)*0.06,
			vy: (Math.random()-0.5)*0.06,
			blink: Math.random()*1.5
		});
	}
}
function drawStars(){
	ctx.clearRect(0,0,W,H);
	for(const s of stars){
		s.x += s.vx; s.y += s.vy;
		s.blink += 0.02;
		const alpha = 0.6 + Math.sin(s.blink)*0.4;
		ctx.globalAlpha = alpha;
		ctx.beginPath();
		ctx.fillStyle = "#ffffff";
		ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
		ctx.fill();
	}
	requestAnimationFrame(drawStars);
}
addEventListener("resize", resizeCanvas);
resizeCanvas();
drawStars();

/* ---------- populate features list in footer ---------- */
const features = [
	"Year progress bar (0–100% by seconds)",
	"Countdown to nearest eclipse",
	"Both Solar & Lunar eclipse calendar (local JSON)",
	"Simple location-based visibility (Option A, approximate)",
	"Animated star background (canvas)",
	"Dark / Light theme toggle",
	"NASA APOD image with offline caching (localStorage)",
	"Refresh NASA APOD button",
	"Responsive single-file HTML/CSS/JS"
];
for(const f of features){
	const el = document.createElement("div"); el.className = "tag"; el.textContent = f; featureTags.appendChild(el);
}

/* ---------- initial hint: autofocus detect location for convenience (optional) ---------- */
// Optionally uncomment to auto-request location on first load
// detectLocation();

</script>
</body>
</html>